<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astor Peak: Unlimited</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --container-bg: rgba(23, 29, 40, 0.85);
            --border-color: #30363d;
            --primary-accent: #5865F2; /* A nice indigo/blurple */
            --primary-accent-hover: #4752C4;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --font-main: 'Inter', sans-serif;
            --font-display: 'Orbitron', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 1px 1px, #30363d 1px, transparent 0);
            background-size: 2rem 2rem;
            color: var(--text-primary);
        }

        #game-container {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        #hud-container {
            font-family: var(--font-display);
        }

        .hud-item {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .hud-item:hover {
            transform: translateY(-2px);
            background-color: rgba(0,0,0,0.4);
            box-shadow: 0 0 15px rgba(88, 101, 242, 0.3);
        }
        
        .option-button, #inventory-button {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .option-button:hover, #inventory-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(88, 101, 242, 0.4);
        }

        #send-button {
            background-color: var(--primary-accent);
        }
        #send-button:hover {
            background-color: var(--primary-accent-hover);
        }
        
        #game-output::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track { background: transparent; }
        #game-output::-webkit-scrollbar-thumb { background: var(--primary-accent); border-radius: 10px; }
        #game-output::-webkit-scrollbar-thumb:hover { background: var(--primary-accent-hover); }
        
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: transform 0.3s ease-in-out; }

        .loading-dots span {
            animation: blink 1.4s infinite both; display: inline-block;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        /* Safari-specific fix for backdrop-filter inside border-radius */
        #game-container, #modal-content {
            -webkit-mask-image: -webkit-radial-gradient(white, black);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="game-container" class="w-full max-w-4xl min-h-[90vh] sm:min-h-[85vh] h-full mx-auto rounded-2xl flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="p-3 border-b" style="border-color: var(--border-color);">
            <h1 class="text-xl md:text-2xl font-bold text-center tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-white to-[var(--primary-accent)]" style="font-family: var(--font-display);">Astor Peak: Unlimited</h1>
        </header>
        
        <!-- HUD -->
        <div id="hud-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 p-3 text-center text-xs sm:text-sm">
            <div class="hud-item p-2 rounded-lg"><span id="hud-money">üíµ $0</span></div>
            <div class="hud-item p-2 rounded-lg"><span id="hud-health">‚ù§Ô∏è 100%</span></div>
            <div class="hud-item p-2 rounded-lg"><span id="hud-reputation">üå§Ô∏è Neutral</span></div>
            <div class="hud-item p-2 rounded-lg"><span id="hud-relationships">üë• None</span></div>
        </div>

        <!-- Game Output -->
        <main id="game-output" class="flex-grow p-4 md:p-6 overflow-y-auto"></main>

        <!-- Footer / Input Area -->
        <footer class="p-3 border-t mt-auto" style="border-color: var(--border-color);">
            <div class="flex items-center justify-center mb-3">
                 <button id="inventory-button" class="bg-gray-700 text-white text-sm font-semibold py-2 px-5 rounded-lg w-full max-w-xs">Inventory</button>
            </div>
            <div id="quick-actions" class="flex flex-wrap gap-2 mb-3 justify-center"></div>
            <div class="flex gap-2">
                <input type="text" id="user-input" class="flex-grow bg-gray-900 border rounded-lg px-4 py-3 focus:outline-none focus:ring-2 w-full" style="border-color: var(--border-color); focus-ring-color: var(--primary-accent);" placeholder="What do you do?">
                <button id="send-button" class="text-white font-bold py-3 px-5 rounded-lg option-button">Send</button>
            </div>
             <div id="version-text" class="text-xs mt-3 text-center" style="color: var(--text-secondary);">v3.2.2 (In Development by OxyIsBad)</div>
        </footer>
    </div>

    <!-- Inventory Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content" class="w-full max-w-md p-6 border rounded-xl shadow-lg transform scale-95" style="background-color: var(--bg-color); border-color: var(--border-color);">
            <h2 class="text-2xl font-bold mb-4" style="font-family: var(--font-display); color: var(--primary-accent);">Inventory</h2>
            <ul id="inventory-list" class="list-disc list-inside mb-6 text-gray-300 space-y-2"></ul>
            <button id="close-modal-button" class="option-button w-full font-bold py-3 px-6 rounded-lg text-white" style="background-color: var(--primary-accent);">Close</button>
        </div>
    </div>

    <script>
        // All JavaScript logic from the previous version remains here.
        // It correctly points to `/api/generate` and does not contain any API keys.
        const output = document.getElementById('game-output');
        const input = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const quickActionsContainer = document.getElementById('quick-actions');
        const hudMoney = document.getElementById('hud-money');
        const hudHealth = document.getElementById('hud-health');
        const hudReputation = document.getElementById('hud-reputation');
        const hudRelationships = document.getElementById('hud-relationships');
        const inventoryButton = document.getElementById('inventory-button');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const inventoryList = document.getElementById('inventory-list');
        const closeModalButton = document.getElementById('close-modal-button');
        const versionText = document.getElementById('version-text');

        let gameState = {
            devMode: false,
            useYourWords: false,
            currentScene: 'start',
            character: { name: '', age: null, gender: '', orientation: '' },
            stats: { money: 0, health: 100, reputation: 0 },
            relationships: {},
            inventory: [],
            location: null,
            history: [],
        };

        function updateHUD() {
            hudMoney.innerHTML = `üíµ $${gameState.stats.money}`;
            hudHealth.innerHTML = `‚ù§Ô∏è ${gameState.stats.health}%`;
            let repText, repEmoji;
            if (gameState.stats.reputation > 75) { repEmoji = 'ÔøΩ'; repText = 'Saint'; }
            else if (gameState.stats.reputation > 50) { repEmoji = 'ü¶∏‚Äç‚ôÇÔ∏è'; repText = 'Hero'; }
            else if (gameState.stats.reputation > 25) { repEmoji = 'ü¶∏‚Äç‚ôÄÔ∏è'; repText = 'Good'; }
            else if (gameState.stats.reputation > -25) { repEmoji = 'üå§Ô∏è'; repText = 'Neutral'; }
            else if (gameState.stats.reputation > -50) { repEmoji = 'üòà'; repText = 'Shady'; }
            else if (gameState.stats.reputation > -75) { repEmoji = 'ü¶π‚Äç‚ôÄÔ∏è'; repText = 'Menace'; }
            else { repEmoji = 'ü¶π'; repText = 'Villain'; }
            hudReputation.textContent = `${repEmoji} ${repText}`;
            const rels = Object.entries(gameState.relationships);
            hudRelationships.textContent = rels.length > 0 ? `üë• ${rels.length} Contacts` : 'üë• None';
        }

        function displayInventory() {
            inventoryList.innerHTML = '';
            if (gameState.inventory.length === 0) {
                inventoryList.innerHTML = '<li class="text-gray-400">Your pockets are empty.</li>';
            } else {
                gameState.inventory.forEach(item => { const li = document.createElement('li'); li.textContent = item; inventoryList.appendChild(li); });
            }
            modalBackdrop.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
             modalBackdrop.classList.add('opacity-0');
             modalContent.classList.add('scale-95');
             setTimeout(() => modalBackdrop.classList.add('hidden'), 300);
        }

        function renderOutput(text, onComplete) {
            const p = document.createElement('p');
            p.className = 'mb-4 text-gray-300';
            output.appendChild(p);

            if(gameState.devMode) {
                p.innerHTML = text.replace(/\n/g, '<br>'); // Respect newlines in devmode
                output.scrollTop = output.scrollHeight;
                if(onComplete) onComplete();
            } else {
                let i = 0;
                const speed = 15;
                function type() {
                    if (i < text.length) {
                        p.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i); i++;
                        output.scrollTop = output.scrollHeight;
                        setTimeout(type, speed);
                    } else { if (onComplete) onComplete(); }
                }
                type();
            }
        }

        function renderQuickActions(actions) {
            quickActionsContainer.innerHTML = '';
            if (!actions || actions.length === 0) return;
            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.className = 'option-button bg-gray-700 text-white text-sm font-semibold py-2 px-3 rounded-lg';
                button.onclick = () => handleInput(action.action);
                quickActionsContainer.appendChild(button);
            });
        }
        
        function showLoading(show) {
            const existingLoading = document.getElementById('loading');
            if (show) {
                if(existingLoading) return;
                const loadingElement = document.createElement('p');
                loadingElement.id = 'loading';
                loadingElement.className = 'text-center text-indigo-400 loading-dots';
                loadingElement.innerHTML = '<span>.</span><span>.</span><span>.</span>';
                output.appendChild(loadingElement);
                output.scrollTop = output.scrollHeight;
            } else {
                if (existingLoading) existingLoading.remove();
            }
        }

        async function generateStory() {
            showLoading(true);
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gameState) 
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    return { text: `Error from server: ${errorBody.error}`, actions: [] };
                }

                const content = await response.json();
                
                gameState.history.push({role: "user", parts: [{text: content.promptSentToAI}]});
                gameState.history.push({role: "model", parts: [{text: JSON.stringify(content)}]});
                
                if (content.newStats) { Object.assign(gameState.stats, content.newStats); }
                if (content.addInventory) { content.addInventory.forEach(item => { if (!gameState.inventory.includes(item)) gameState.inventory.push(item); }); }
                if (content.removeInventory) { gameState.inventory = gameState.inventory.filter(item => !content.removeInventory.includes(item)); }
                if (content.newRelationships) { Object.assign(gameState.relationships, content.newRelationships); }

                return content;

            } catch (error) {
                console.error("Fetch/System Error:", error);
                return { text: `A system error occurred: ${error.message}. Check the console.`, actions: [] };
            } finally {
                showLoading(false);
            }
        }
        
        async function handleInput(value) {
            const playerInput = value.trim();
            if (playerInput === '' || document.getElementById('loading')) return;

            if (playerInput.startsWith('/')) {
                const command = playerInput.toLowerCase();
                let responseText;
                if (command === '/devmode') {
                    gameState.devMode = !gameState.devMode;
                    responseText = `DEVMODE is now ${gameState.devMode ? 'ON' : 'OFF'}. Fast-typing enabled.`;
                } else if (command === '/useyourwords') {
                    gameState.useYourWords = !gameState.useYourWords;
                    responseText = `Explicit language is now ${gameState.useYourWords ? 'ENABLED' : 'DISABLED'}.`;
                } else {
                    responseText = `Unknown command: ${playerInput}`;
                }
                const p = document.createElement('p');
                p.className = 'text-center text-yellow-400 italic mb-4';
                p.textContent = responseText;
                output.appendChild(p);
                input.value = '';
                output.scrollTop = output.scrollHeight;
                return;
            }

            const playerActionElement = document.createElement('p');
            playerActionElement.className = 'text-right text-indigo-300 italic mb-4';
            playerActionElement.textContent = `> ${playerInput}`;
            output.appendChild(playerActionElement);
            
            input.value = '';
            renderQuickActions([]);
            output.scrollTop = output.scrollHeight;

            let response;
            if (gameState.currentScene.startsWith('in_game')) {
                const prompt = `USER ACTION: "${playerInput}"`;
                gameState.history.push({role: "user", parts: [{text: prompt}]});
                response = await generateStory();
            } else {
                response = getSetupResponse(playerInput);
            }
            
            renderOutput(response.text, () => {
                renderQuickActions(response.actions);
                updateHUD();
                output.scrollTop = output.scrollHeight;
            });
        }
        
        function getSetupResponse(playerInput) {
            // Setup logic remains the same
            switch (gameState.currentScene) {
                case 'start':
                    if (playerInput.toLowerCase() === 'play') {
                        gameState.currentScene = 'location_select';
                        return { text: "The smog-filled sky of Astor Peak presses down... Where do you find yourself?", actions: [ 
                            { text: "Ghetto", action: "1" }, { text: "Arcade", action: "2" }, { text: "Playground", action: "3" },
                            { text: "School", action: "4" }, { text: "Suburbs", action: "5" }, { text: "High-Rise", action: "6" },
                            { text: "Downtown Office", action: "7" }
                        ]};
                    }
                    return { text: "type PLAY to begin (Astor Peak: Unlimited)." };
                
                case 'location_select':
                    const locations = {'1': 'Ghetto', '2': 'Arcade', '3': 'Playground', '4': 'School', '5': 'Suburbs', '6': 'High-Rise Apartment', '7': 'Downtown Office'};
                    if (locations[playerInput]) {
                        gameState.location = locations[playerInput];
                        gameState.currentScene = 'create_name';
                        const intros = {
                            'Ghetto': "The smell of stale beer, damp concrete, and desperation hangs heavy.",
                            'Arcade': "Neon lights bleed across sticky floors. The air is thick with the electric hum of machines.",
                            'Playground': "Rusting chains squeak in the wind. A single red ball sits abandoned in the sandbox.",
                            'School': "The silence of empty hallways is deafening. The lingering smell of floor wax and teenage angst remains.",
                            'Suburbs': "Manicured lawns and cookie-cutter houses hide secrets behind closed doors.",
                            'High-Rise Apartment': "Floor-to-ceiling windows offer a god's-eye view of the sprawling city below.",
                            'Downtown Office': "The sterile, air-conditioned silence is broken only by the clacking of keyboards."
                        };
                        return { text: `${intros[gameState.location]} Before your story begins, who are you? What is your name?` };
                    }
                    return { text: "Please select a valid location." };

                case 'create_name': gameState.character.name = playerInput.trim(); gameState.currentScene = 'create_age'; return { text: `Alright, ${gameState.character.name}. How old are you?` };
                
                case 'create_age':
                    const age = parseInt(playerInput, 10);
                    if (!isNaN(age) && age >= 18) { gameState.character.age = age; gameState.currentScene = 'create_gender'; return { text: `Age ${age}. And your gender?` }; }
                    return { text: "Please enter a valid age (18+)." };

                case 'create_gender': gameState.character.gender = playerInput.trim(); gameState.currentScene = 'create_orientation'; return { text: `And finally, what is your sexual orientation?` };
                
                case 'create_orientation':
                    gameState.character.orientation = playerInput.trim();
                    gameState.currentScene = 'in_game_start';
                    handleInput("START_GAME");
                    return { text: "Your story is about to begin..." };
            }
        }
        
        sendButton.addEventListener('click', () => handleInput(input.value));
        input.addEventListener('keyup', (event) => { if (event.key === 'Enter') { handleInput(input.value); } });
        inventoryButton.addEventListener('click', displayInventory);
        closeModalButton.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

        function init() {
            updateHUD();
            renderOutput("type PLAY to begin (Astor Peak: Unlimited).", () => {
                 renderQuickActions([{ text: "PLAY", action: "play" }]);
            });
        }

        init();
    </script>
</body>
</html>
ÔøΩ
